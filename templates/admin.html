<!-- templates/admin.html -->
{% extends "base.html" %}

{% block content %}
<div class="bg-white p-8 rounded-lg shadow-xl w-full border border-gray-200">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Administrator Panel</h1>

    <!-- User Management Link -->
    <div class="mb-8 p-6 bg-purple-50 rounded-lg border border-purple-200">
        <h2 class="text-2xl font-semibold text-purple-800 mb-4">User Management</h2>
        <p class="text-gray-700 mb-4">
            Manage application users, including adding new users, editing existing accounts, and assigning roles.
        </p>
        {# Corrected link to use the 'manage_users' endpoint #}
        <a href="{{ url_for('manage_users') }}"
           class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:shadow-outline transition-colors duration-200 shadow-md">
            Go to User Management
        </a>
    </div>

    <!-- License Management Section -->
    <div class="mb-8 p-6 bg-purple-50 rounded-lg border border-purple-200">
        <h2 class="text-2xl font-semibold text-purple-800 mb-4">License Management</h2>
        <p class="text-gray-700 mb-4">
            Manage the application's license. If the license is not active or valid,
            risk data displayed on the dashboard will be limited to 5 rows.
            Use the standalone `license_generator.py` script to generate a valid License Key (Hash).
        </p>
        <div class="mb-4">
            <p class="font-semibold text-purple-700">Current License Status: <span class="font-bold">{{ license_status }}</span></p>
            {% if license_expiry_date %}
                <p class="text-gray-600">Expiry Date: {{ license_expiry_date }}</p>
            {% endif %}
            {% if license_transaction_limit %}
                <p class="text-gray-600">Transaction Limit: {{ license_transaction_limit }}</p>
            {% endif %}
        </div>
        <form action="{{ url_for('set_license') }}" method="POST" class="space-y-4">
            <div class="mb-4">
                <label for="expiry_date" class="block text-gray-700 text-sm font-semibold mb-2">License Expiry Date:</label>
                <input type="date" id="expiry_date" name="expiry_date" required
                       value="{{ license_expiry_date }}"
                       class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
            </div>
            <div class="mb-4">
                <label for="transaction_limit" class="block text-gray-700 text-sm font-semibold mb-2">Transaction Limit:</label>
                <input type="number" id="transaction_limit" name="transaction_limit" required
                       min="0" value="{{ license_transaction_limit }}"
                       class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                <p class="text-gray-500 text-xs mt-1">Set to 0 for no transactions, or a high number for effectively unlimited.</p>
            </div>
            <div class="mb-4">
                <label for="license_key" class="block text-gray-700 text-sm font-semibold mb-2">License Key (Hash):</label>
                <input type="text" id="license_key" name="license_key" required
                       placeholder="Paste the generated license hash here"
                       class="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                <p class="text-gray-500 text-xs mt-1">This hash must be generated by the `license_generator.py` script.</p>
            </div>
            <button type="submit"
                    class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:shadow-outline transition-colors duration-200 shadow-md">
                Validate & Set License
            </button>
        </form>
    </div>

    <div class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
        <h2 class="text-2xl font-semibold text-blue-800 mb-4">Import Risk Data</h2>
        <p class="text-gray-700 mb-4">
            Use this section to clear all existing risk data and import new data from a CSV or XLSX file.
            <strong class="text-red-600">This action is irreversible and will delete all current risk records.</strong>
        </p>
        <form action="{{ url_for('upload_risks') }}" method="POST" enctype="multipart/form-data" class="space-y-4">
            <div class="mb-4">
                <label for="file" class="block text-gray-700 text-sm font-semibold mb-2">Select CSV/XLSX File:</label>
                <input type="file" id="file" name="file" accept=".csv, .xlsx" required
                       class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <button type="submit"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:shadow-outline transition-colors duration-200 shadow-md">
                Clear & Import Data
            </button>
        </form>
    </div>

    <div class="mb-8 p-6 bg-indigo-50 rounded-lg border border-indigo-200">
        <h2 class="text-2xl font-semibold text-indigo-800 mb-4">Append Risk Data</h2>
        <p class="text-gray-700 mb-4">
            Use this section to append new risk data from a CSV or XLSX file.
            Existing risks with matching "Risk Number" will be skipped.
        </p>
        <form action="{{ url_for('append_risks_route') }}" method="POST" enctype="multipart/form-data" class="space-y-4">
            <div class="mb-4">
                <label for="append_file" class="block text-gray-700 text-sm font-semibold mb-2">Select CSV/XLSX File to Append:</label>
                <input type="file" id="append_file" name="file" accept=".csv, .xlsx" required
                       class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
            </div>
            <button type="submit"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:shadow-outline transition-colors duration-200 shadow-md">
                Append Data
            </button>
        </form>
    </div>

    <div class="mt-8 p-6 bg-green-50 rounded-lg border border-green-200">
        <h2 class="text-2xl font-semibold text-green-800 mb-4">Test Residual Exposure Calculation</h2>
        <p class="text-gray-700 mb-4">
            Click the button below to test the "Residual Exposure (New)" calculation with Inherent Rating "Medium" and Control Effectiveness "Satisfactory".
            Expected result: "Priority 3".
        </p>
        <button type="button" id="testResidualExposureBtn"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-colors">
            Test Residual Exposure
        </button>
        <div id="testResult" class="mt-4 p-3 bg-green-100 border border-green-300 rounded-md text-green-800 font-semibold" style="display: none;">
            <!-- Test result will be displayed here -->
        </div>
    </div>

    <div class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Other Admin Options (Placeholder)</h2>
        <p class="text-gray-700">
            You can add more administrative functionalities here, such as:
        </p>
        <ul class="list-disc list-inside text-gray-600 mt-2 space-y-1">
            <li>User management (add/edit/delete users, change roles)</li>
            <li>Database backup/restore</li>
            <li>System settings</li>
        </ul>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const testResidualExposureBtn = document.getElementById('testResidualExposureBtn');
        const testResultDiv = document.getElementById('testResult');

        // This function is a client-side copy of the backend logic for testing purposes
        function calculateResidualExposure(inherentRating, controlEffectiveness) {
            if (!inherentRating || !controlEffectiveness) {
                return '';
            }

            const mapping = {
                "Housekeeping": {
                    "Unsatisfactory": "Priority 3", "Weak": "Priority 3", "Satisfactory": "Priority 4",
                    "Good": "Priority 5", "Very Good": "Priority 5"
                },
                "Low": {
                    "Unsatisfactory": "Priority 2", "Weak": "Priority 3", "Satisfactory": "Priority 3",
                    "Good": "Priority 4", "Very Good": "Priority 5"
                },
                "Medium": {
                    "Unsatisfactory": "Priority 1", "Weak": "Priority 2", "Satisfactory": "Priority 3",
                    "Good": "Priority 3", "Very Good": "Priority 4"
                },
                "High": {
                    "Unsatisfactory": "Priority 1", "Weak": "Priority 1", "Satisfactory": "Priority 2",
                    "Good": "Priority 2", "Very Good": "Priority 3"
                },
                "Extreme": {
                    "Unsatisfactory": "Priority 1", "Weak": "Priority 1", "Satisfactory": "Priority 1",
                    "Good": "Priority 2", "Very Good": "Priority 2"
                }
            };
            return (mapping[inherentRating] && mapping[inherentRating][controlEffectiveness]) || '';
        }

        testResidualExposureBtn.addEventListener('click', function() {
            const testInherentRating = "Medium";
            const testControlEffectiveness = "Satisfactory";
            const result = calculateResidualExposure(testInherentRating, testControlEffectiveness);

            testResultDiv.textContent = `Test Result: Inherent Rating "${testInherentRating}", Control Effectiveness "${testControlEffectiveness}" => Residual Exposure "${result}"`;
            testResultDiv.style.display = 'block';
        });
    });
</script>
{% endblock %}
